# Session Summary - January 26, 2026

## Overview
Major implementation session covering Supabase authentication, custom Europa-Park map tiles, and various bug fixes.

---

## 1. Supabase Authentication Implementation

### What was built:
- Email/password authentication using Supabase Auth
- User profile management with `profiles` table
- Display name collection during signup
- Session persistence across app reloads
- Protected routes - app only accessible when authenticated

### Key Files:
- `src/config/supabase.js` - Supabase client configuration
- `src/screens/LoginScreen.js` - Login/signup UI
- `src/screens/UserScreen.js` - User profile display
- `src/game/GameProvider.js` - Auth state management

### Decisions Made:
1. **Hardcoded Supabase credentials** - Environment variables via `.env` weren't loading reliably in Expo web. Credentials are public (anon key), so hardcoding is acceptable.
2. **Email verification disabled** - User disabled this in Supabase dashboard; all verification code was removed.
3. **Display name stored in user_metadata** - Collected during signup, synced to `profiles` table.
4. **Deleted user handling** - If profile fetch returns 404, user is automatically signed out.

### Database Schema:
```sql
-- profiles table (created via Supabase trigger on auth.users insert)
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  display_name TEXT,
  level INTEGER DEFAULT 1,
  xp INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 2. Custom Europa-Park Map Tiles

### Problem:
Needed to display Europa-Park's interactive map in the app with custom markers.

### Solution:
1. **Scraped tiles** from Europa-Park's website using a custom Node.js script
2. **Stored locally** in `public/tiles/{z}/{x}/{y}.png`
3. **Integrated with Leaflet** using `L.CRS.Simple` for pixel-based coordinates

### Tile Structure:
- Zoom levels: 2-7
- At z=7 (max detail): 59×76 tiles = 15,104×19,456 pixels
- Tile counts per zoom:
  ```javascript
  { 2: {x:2, y:3}, 3: {x:4, y:5}, 4: {x:8, y:10}, 
    5: {x:15, y:19}, 6: {x:30, y:38}, 7: {x:59, y:76} }
  ```

### Key Challenges Solved:

#### Challenge 1: Tiles not loading (green screen)
- **Cause**: Coordinate system mismatch between Leaflet and tile structure
- **Solution**: Used small coordinate space (120×152 units) that maps directly to tile indices

#### Challenge 2: Tiles doubled/repeated
- **Cause**: Custom coordinate transformation was mapping multiple Leaflet tiles to same source tile
- **Solution**: Removed transformation, used direct tile index passthrough

#### Challenge 3: Negative tile indices
- **Cause**: Y-flip formula producing negative values
- **Solution**: Removed Y-flip entirely - tiles already in correct orientation

#### Challenge 4: Map snapping back to user location
- **Cause**: `setMaxBounds` was restricting panning
- **Solution**: Removed `setMaxBounds` call

### Final Working Configuration:
```javascript
// Coordinate space based on zoom 5
const MAP_WIDTH = 120;
const MAP_HEIGHT = 152;

// Simple tile layer - NO transformations
L.TileLayer.EuropaPark = L.TileLayer.extend({
  getTileUrl: function(coords) {
    const z = coords.z;
    const info = TILE_INFO[z];
    if (!info) return '';
    
    const x = coords.x;
    const y = coords.y;  // Direct passthrough, no flip
    
    if (x < 0 || x >= info.x || y < 0 || y >= info.y) {
      return '';
    }
    
    return this._url.replace('{z}', z).replace('{x}', x).replace('{y}', y);
  }
});
```

### GPS to Pixel Conversion:
```javascript
const GPS_BOUNDS = {
  minLat: 48.2620, maxLat: 48.2740,
  minLng: 7.7140, maxLng: 7.7320
};

function gpsToPixel(lat, lng) {
  const yPct = (lat - GPS_BOUNDS.minLat) / (GPS_BOUNDS.maxLat - GPS_BOUNDS.minLat);
  const xPct = (lng - GPS_BOUNDS.minLng) / (GPS_BOUNDS.maxLng - GPS_BOUNDS.minLng);
  
  const coordX = COORD_BOUNDS.minX + xPct * (COORD_BOUNDS.maxX - COORD_BOUNDS.minX);
  const imageY = COORD_BOUNDS.minY + (1 - yPct) * (COORD_BOUNDS.maxY - COORD_BOUNDS.minY);
  const coordY = MAP_HEIGHT - imageY;
  
  return [coordY, coordX];
}
```

---

## 3. Supabase Data Migration

### Tables Created:
1. **`locations`** - Park locations with GPS coordinates
2. **`quests`** - Quest templates with rewards and requirements  
3. **`user_quests`** - User's active/completed quests (single source of truth)

### Key Decision:
**Supabase as single source of truth** - Removed all AsyncStorage persistence for game data. Only the auth token is stored locally; all game state comes from Supabase.

### Quest Flow:
1. App fetches `quests` and `locations` from Supabase on startup
2. User accepts quest → `INSERT` into `user_quests`
3. Quest progress → `UPDATE` on `user_quests`
4. Quest completion → `UPDATE` status to 'completed', update `profiles.xp`

---

## 4. Map Flickering Fix

### Problem:
Map component was re-rendering constantly, showing "Standort wird gesucht" repeatedly.

### Cause:
- `withSuspense(MapScreen)` was defined inside `AppNavigator` component
- Every re-render created a new wrapped component
- `GameContext` value wasn't memoized

### Solution:
1. Defined wrapped screen components OUTSIDE the navigator
2. Memoized `GameContext` value with `useMemo`
3. Disabled continuous location watching on web

---

## 5. Tile Scraping Script

### Location: `scripts/scrape-europapark-tiles.js`

### Features:
- Downloads tiles from Europa-Park's tile server
- Rate limiting (100ms delay between requests)
- Browser-like headers to avoid bot detection
- Auto-discovers tile bounds
- Saves bounds to `public/tiles/bounds.json`

### Usage:
```bash
node scripts/scrape-europapark-tiles.js
```

---

## 6. Files Modified/Created

### New Files:
- `src/config/supabase.js`
- `src/screens/LoginScreen.js`
- `src/screens/UserScreen.js`
- `scripts/scrape-europapark-tiles.js`
- `public/tiles/` (6000+ tile images)
- `supabase/schema.sql`

### Modified Files:
- `App.js` - Auth guard, SafeAreaProvider wrapper
- `src/game/GameProvider.js` - Auth state, Supabase data fetching
- `src/game/hooks/useQuests.js` - Supabase integration
- `src/screens/VibeMapScreen.js` - Custom tile layer
- `src/navigation/AppNavigator.js` - User tab, screen stabilization

---

## 7. Known Issues / Future Work

1. **GPS bounds need calibration** - The `GPS_BOUNDS` and `COORD_BOUNDS` values are approximations; need real-world testing at the park
2. **Quest markers** - Currently using placeholder coordinates; need real location data
3. **Tile storage** - 100MB in repo; consider Git LFS if it grows
4. **Offline support** - Tiles are loaded from local files, but Supabase data requires internet

---

## 8. Commands Reference

```bash
# Start Expo web
npx expo start --web

# Start with cache clear
npx expo start --web --clear

# Run tile scraper
node scripts/scrape-europapark-tiles.js

# Check tile file sizes
Get-ChildItem "public/tiles" -Recurse -File | Measure-Object -Property Length -Sum
```
